package textExcel;

public class FormulaCell extends RealCell{
	Spreadsheet original;
	
	public FormulaCell(String value, Spreadsheet sheet){
		super(value);
		original = sheet;
	}

	public double getDouble(){
		double output = 0.0;
		String[] splitInput = fullCellText().split(" ");

		for(int i = 0; i < splitInput.length; i++){		
			//acts as first value
			if(splitInput[i].equals("(") && !splitInput[i + 1].toLowerCase().equals("sum") && !splitInput[i + 1].toLowerCase().equals("avg")){
				output += locationVal(splitInput[i + 1]);
			}
			if(splitInput[i].equalsIgnoreCase("avg")){
				Double[] sumValues = getSumValues(splitInput[i + 1]);
				for(Double values : sumValues){
					output += values;
				}
				output /= sumValues.length;
			}
			if(splitInput[i].equalsIgnoreCase("sum")){
				Double[] sumValues = getSumValues(splitInput[i + 1]);
				for(Double values : sumValues){
					output += values;
				}
			}
			//adds next value to output if it's addition
			if(splitInput[i].equals("+")){
				output += locationVal(splitInput[i+1]);
			}
			//subtracts next value to output if it's subtraction
			if(splitInput[i].equals("-")){
				output -= locationVal(splitInput[i+1]);
			}
			//multiply
			if(splitInput[i].equals("*")){
				output *= locationVal(splitInput[i+1]);
			}
			//divide
			if(splitInput[i].equals("/")){
				output /= locationVal(splitInput[i+1]);
			}
		}
		return output;
	}
	
	public Double[] getSumValues(String range){
		String[] startEnd = range.split("-");
		
		SpreadsheetLocation start = new SpreadsheetLocation(startEnd[0]);
		SpreadsheetLocation end = new SpreadsheetLocation(startEnd[1]);
		
		int firstRow = start.getRow();
		int lastRow = end.getRow();
		int firstCol = start.getCol();
		int lastCol = end.getCol();

		int numRows = (lastRow - firstRow) + 1;
		int numCols = (lastCol - firstCol) + 1; 

		SpreadsheetLocation[] cellLocs = new SpreadsheetLocation[numRows * numCols];
		
		for (int i = 0; firstRow <= lastRow; firstRow++) {
			for (int j = firstCol; j <= lastCol; j++, i++) {
				cellLocs[i] = new SpreadsheetLocation(firstRow, j);
			}
		}
		
		Double[] cellValues = new Double[cellLocs.length];
		for(int i = 0; i < cellValues.length; i++){
			Cell c = original.getCell(cellLocs[i]);
			cellValues[i] = ((RealCell)c).getDouble();
		}
		return cellValues;
	}

	public double locationVal(String cellSpot){
		double cellValue;
		String colLetter = cellSpot.substring(0, 1).toLowerCase();
		//is a cell identifier if conditions met
		if(colLetter.matches("[a-l]")){
			SpreadsheetLocation spot = new SpreadsheetLocation(cellSpot);
			Cell c = original.getCell(spot);
			cellValue = ((RealCell)c).getDouble();
		}else{
			cellValue = Double.parseDouble(cellSpot);
		}
		return cellValue;
	}

	public String cellContents(){
		return "FormulaCell";
	}
}

